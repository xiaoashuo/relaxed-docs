<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Oauth2的基本使用 | Relaxed-Docs</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/relaxed-docs/assets/css/0.styles.9065c141.css" as="style"><link rel="preload" href="/relaxed-docs/assets/js/app.600cf0bb.js" as="script"><link rel="preload" href="/relaxed-docs/assets/js/7.58e239fa.js" as="script"><link rel="preload" href="/relaxed-docs/assets/js/2.a3c8aac3.js" as="script"><link rel="preload" href="/relaxed-docs/assets/js/1.ecce0b60.js" as="script"><link rel="preload" href="/relaxed-docs/assets/js/47.d1de22f4.js" as="script"><link rel="prefetch" href="/relaxed-docs/assets/js/10.dd8194b2.js"><link rel="prefetch" href="/relaxed-docs/assets/js/11.3ad1a363.js"><link rel="prefetch" href="/relaxed-docs/assets/js/14.63f7c3eb.js"><link rel="prefetch" href="/relaxed-docs/assets/js/15.89ac765f.js"><link rel="prefetch" href="/relaxed-docs/assets/js/16.1f61d0b6.js"><link rel="prefetch" href="/relaxed-docs/assets/js/17.3a89f134.js"><link rel="prefetch" href="/relaxed-docs/assets/js/18.0789a874.js"><link rel="prefetch" href="/relaxed-docs/assets/js/19.da2bcae3.js"><link rel="prefetch" href="/relaxed-docs/assets/js/20.5a11f08f.js"><link rel="prefetch" href="/relaxed-docs/assets/js/21.7d7f74ae.js"><link rel="prefetch" href="/relaxed-docs/assets/js/22.d2a353cf.js"><link rel="prefetch" href="/relaxed-docs/assets/js/23.f7967266.js"><link rel="prefetch" href="/relaxed-docs/assets/js/24.b2b0eba6.js"><link rel="prefetch" href="/relaxed-docs/assets/js/25.4cde7367.js"><link rel="prefetch" href="/relaxed-docs/assets/js/26.fb856202.js"><link rel="prefetch" href="/relaxed-docs/assets/js/27.b6ac8d8a.js"><link rel="prefetch" href="/relaxed-docs/assets/js/28.8d71e48f.js"><link rel="prefetch" href="/relaxed-docs/assets/js/29.4c343241.js"><link rel="prefetch" href="/relaxed-docs/assets/js/3.b5851ee9.js"><link rel="prefetch" href="/relaxed-docs/assets/js/30.c85c905b.js"><link rel="prefetch" href="/relaxed-docs/assets/js/31.7bd74feb.js"><link rel="prefetch" href="/relaxed-docs/assets/js/32.3e398343.js"><link rel="prefetch" href="/relaxed-docs/assets/js/33.2001bcae.js"><link rel="prefetch" href="/relaxed-docs/assets/js/34.65cf3022.js"><link rel="prefetch" href="/relaxed-docs/assets/js/35.42acae6e.js"><link rel="prefetch" href="/relaxed-docs/assets/js/36.4b7c59c9.js"><link rel="prefetch" href="/relaxed-docs/assets/js/37.206dee2e.js"><link rel="prefetch" href="/relaxed-docs/assets/js/38.58fac351.js"><link rel="prefetch" href="/relaxed-docs/assets/js/39.0f303d10.js"><link rel="prefetch" href="/relaxed-docs/assets/js/4.4e034b5f.js"><link rel="prefetch" href="/relaxed-docs/assets/js/40.4aeda198.js"><link rel="prefetch" href="/relaxed-docs/assets/js/41.9bb5e866.js"><link rel="prefetch" href="/relaxed-docs/assets/js/42.de5130cf.js"><link rel="prefetch" href="/relaxed-docs/assets/js/43.e91c5415.js"><link rel="prefetch" href="/relaxed-docs/assets/js/44.23cc34f1.js"><link rel="prefetch" href="/relaxed-docs/assets/js/45.72e20181.js"><link rel="prefetch" href="/relaxed-docs/assets/js/46.b52b8104.js"><link rel="prefetch" href="/relaxed-docs/assets/js/48.b89d85cf.js"><link rel="prefetch" href="/relaxed-docs/assets/js/49.6eb79707.js"><link rel="prefetch" href="/relaxed-docs/assets/js/5.76d66c0e.js"><link rel="prefetch" href="/relaxed-docs/assets/js/50.9fcf0b81.js"><link rel="prefetch" href="/relaxed-docs/assets/js/51.e9d705f8.js"><link rel="prefetch" href="/relaxed-docs/assets/js/52.beebf8ab.js"><link rel="prefetch" href="/relaxed-docs/assets/js/53.e1ed8768.js"><link rel="prefetch" href="/relaxed-docs/assets/js/54.98f9ab79.js"><link rel="prefetch" href="/relaxed-docs/assets/js/55.2c7b4f97.js"><link rel="prefetch" href="/relaxed-docs/assets/js/56.2088deb0.js"><link rel="prefetch" href="/relaxed-docs/assets/js/57.55d305fe.js"><link rel="prefetch" href="/relaxed-docs/assets/js/58.2b7dcaa6.js"><link rel="prefetch" href="/relaxed-docs/assets/js/59.e470b6d4.js"><link rel="prefetch" href="/relaxed-docs/assets/js/6.bf181215.js"><link rel="prefetch" href="/relaxed-docs/assets/js/8.0fb025a4.js"><link rel="prefetch" href="/relaxed-docs/assets/js/9.cf50136a.js"><link rel="prefetch" href="/relaxed-docs/assets/js/vendors~docsearch.ea1f12ce.js">
    <link rel="stylesheet" href="/relaxed-docs/assets/css/0.styles.9065c141.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>Relaxed-Docs</h3> <p class="description" data-v-59e6cb88>Just playing around</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2025
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/relaxed-docs/" class="home-link router-link-active"><img src="./img/logo.png" alt="Relaxed-Docs" class="logo"> <span class="site-name">Relaxed-Docs</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/relaxed-docs/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      前端项目
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://cn.vuejs.org/guide/introduction.html" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Vue
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://vuepress.vuejs.org/zh/guide/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  VuePress
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://vuex.vuejs.org/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Vuex
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://pinia.web3doc.top/introduction.html" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Pinia
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://router.vuejs.org/zh/introduction.html" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  VueRouter
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://www.axios-js.com/zh-cn/docs/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Axios
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><h4>项目模板</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.builtatlightspeed.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Ui模板市场
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://pro.antdv.com/docs/getting-started" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  AntdV
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://pro.ant.design/zh-CN/docs/overview" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Antd
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://panjiachen.github.io/vue-element-admin-site/zh/guide/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  VueElementAdmin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      项目地址
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://spring.io/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Spring
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiaoashuo/relaxed" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  后台项目
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiaoashuo/relaxed-admin-loan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  贷款项目
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><!----> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>21</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>0</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/relaxed-docs/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      前端项目
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://cn.vuejs.org/guide/introduction.html" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Vue
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://vuepress.vuejs.org/zh/guide/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  VuePress
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://vuex.vuejs.org/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Vuex
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://pinia.web3doc.top/introduction.html" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Pinia
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://router.vuejs.org/zh/introduction.html" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  VueRouter
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="http://www.axios-js.com/zh-cn/docs/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Axios
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><h4>项目模板</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.builtatlightspeed.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Ui模板市场
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://pro.antdv.com/docs/getting-started" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  AntdV
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://pro.ant.design/zh-CN/docs/overview" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Antd
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://panjiachen.github.io/vue-element-admin-site/zh/guide/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  VueElementAdmin
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      项目地址
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://spring.io/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Spring
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiaoashuo/relaxed" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  后台项目
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/xiaoashuo/relaxed-admin-loan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  贷款项目
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>主题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/relaxed-docs/zh/guide/" class="sidebar-link">项目描述</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>功能</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/relaxed-docs/zh/blogs/Download模块.html" class="sidebar-link">Download模块</a></li><li><a href="/relaxed-docs/zh/blogs/util模块.html" class="sidebar-link">Util模块</a></li><li><a href="/relaxed-docs/zh/blogs/Excel模块.html" class="sidebar-link">Excel导入导出</a></li><li><a href="/relaxed-docs/zh/blogs/OSS模块.html" class="sidebar-link">OSS使用</a></li><li><a href="/relaxed-docs/zh/blogs/Sftp模块.html" class="sidebar-link">Sftp使用</a></li><li><a href="/relaxed-docs/zh/blogs/Secret模块.html" class="sidebar-link">Secret使用</a></li><li><a href="/relaxed-docs/zh/blogs/多数据源模块.html" class="sidebar-link">多数据源</a></li><li><a href="/relaxed-docs/zh/blogs/异常通知模块.html" class="sidebar-link">异常通知模块</a></li><li><a href="/relaxed-docs/zh/blogs/邮件模块.html" class="sidebar-link">邮件模块</a></li><li><a href="/relaxed-docs/zh/blogs/MybatisPlus模块.html" class="sidebar-link">MybatisPlus 模块</a></li><li><a href="/relaxed-docs/zh/blogs/Mybatis实现字段加解密.html" class="sidebar-link">Mybtias实现字段加解密</a></li><li><a href="/relaxed-docs/zh/blogs/Oauth2模块.html" class="active sidebar-link">Oauth2的基本使用</a></li><li><a href="/relaxed-docs/zh/blogs/Cache模块.html" class="sidebar-link">Cache模块</a></li><li><a href="/relaxed-docs/zh/blogs/日志模块.html" class="sidebar-link">日志模块</a></li><li><a href="/relaxed-docs/zh/blogs/POI模块.html" class="sidebar-link">POI模块</a></li><li><a href="/relaxed-docs/zh/blogs/XXL-JOB模块.html" class="sidebar-link">XXL-JOB模块</a></li><li><a href="/relaxed-docs/zh/blogs/线程池监控.html" class="sidebar-link">线程池监控</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Maven插件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/relaxed-docs/zh/maven/pojo-to-sql.html" class="sidebar-link">pojo-sql-maven-plugin</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>常见问题</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/relaxed-docs/zh/question/SFTP工具类异常.html" class="sidebar-link">SFTP工具类异常</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88></h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2025
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">Oauth2的基本使用</h1> <div data-v-8a445198><!----> <!----> <!----> <!----></div></div> <div class="theme-reco-content content__default"><h1 id="oauth2的基本使用"><a href="#oauth2的基本使用" class="header-anchor">#</a> Oauth2的基本使用</h1> <h2 id="简介"><a href="#简介" class="header-anchor">#</a> 简介</h2> <p>参考: http://www.ballcat.cn/guide/security/oauth2.html#%E6%8E%88%E6%9D%83%E8%AE%B8%E5%8F%AF</p> <p>这里只摘抄了部分文档，以便大家粗略了解 OAuth2 的 4 种授权类型。</p> <p>更多内容可阅读 <a href="https://datatracker.ietf.org/doc/html/rfc6749" target="_blank" rel="noopener noreferrer">OAuth2 RFC6749open in new window<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，中文翻译参看 <a href="https://www.bookstack.cn/read/RFC6749.zh-cn/SUMMARY.md" target="_blank" rel="noopener noreferrer">RFC6749 中文open in new window<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>OAuth 2.0 是一种授权协议。</p> <p>在 OAuth 2.0 协议中，客户端在请求受保护的资源时，会通过一个 access token（一个代表特定的作用域、生命周期以及其他访问属性的字符串）来作为凭证，access token 由授权服务器在资源所有者认可的情况下颁发给第三方客户端。</p> <p>先扔一张 OAuth 2.0 的 4 中授权许可的总结表格，防止下面文章太长不看：</p> <p><img src="https://hccake-img.oss-cn-shanghai.aliyuncs.com/md-source/OAuth2.png" alt="OAuth2"></p> <h2 id="角色"><a href="#角色" class="header-anchor">#</a> 角色</h2> <p>OAuth 中定义了 4 种角色：</p> <ul><li><strong>资源所有者</strong> <code>resource owner</code>：</li></ul> <p>能够授予对受保护资源的访问权的实体。 当资源所有者是人时，它被称为 end-user。</p> <ul><li><p><strong>资源服务器</strong> <code>reosource server</code>：</p> <p>存放受保护资源的服务器，能够通过 access token 来请求和响应这些受保护的资源。</p></li> <li><p><strong>客户端</strong> <code>client</code>：</p> <p>请求受保护资源的的一方就可以被看作一个客户端。（这个客户端只是一个概念，具体实现可以是服务器，应用程序，或者 Html 网页 等等，一个资源服务器在请求另一个资源服务器的受保护资源时，其也被视为一个客户端）</p></li> <li><p><strong>授权服务器</strong> <code>authorization server</code>：</p> <p>当客户端成功通过认证后，向其颁发 token 的服务器</p></li></ul> <h2 id="协议流程"><a href="#协议流程" class="header-anchor">#</a> 协议流程</h2> <p>整体的协议流程大致可以抽象为下图所示，实际的执行流程，根据不同的授权方式，会各有不同。</p> <div class="language-text extra-class"><pre class="language-text"><code>     +--------+                               +---------------+
     |        |--(A)- Authorization Request -&gt;|   Resource    |
     |        |                               |     Owner     |
     |        |&amp;lt;-(B)-- Authorization Grant ---|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(C)-- Authorization Grant --&gt;| Authorization |
     | Client |                               |     Server    |
     |        |&amp;lt;-(D)----- Access Token -------|               |
     |        |                               +---------------+
     |        |
     |        |                               +---------------+
     |        |--(E)----- Access Token ------&gt;|    Resource   |
     |        |                               |     Server    |
     |        |&amp;lt;-(F)--- Protected Resource ---|               |
     +--------+                               +---------------+
</code></pre></div><ul><li>(A) 客户端向资源所有者请求授权。 授权请求可以直接向资源所有者发出(例如密码模式，资源所有者会直接将自己的用户名密码授予给客户端)，但是推荐客户端经由授权服务器作为中转向资源所有者发出(例如授权码模式)</li> <li>(B) 客户端收到授权许可，这是一个代表资源所有者的授权的凭据，使用本规范中定义的四种许可类型之一或者使用扩展许可类型表示。授权许可类型取决于客户端请求授权所使用的方法以及授权服务器支持的类型。</li> <li>(C) 客户端与授权服务器进行身份认证并出示授权许可来请求 access token 。</li> <li>(D) 授权服务器验证客户端以及授权许可，如果授权许可有效，则发出 access token 。</li> <li>(E) 客户端向资源服务器请求受保护的资源，并携带 access token 以进行身份验证。</li> <li>(F) 资源服务器验证 access token ，如果有效，则返回其请求的受保护资源。</li></ul> <h2 id="授权许可"><a href="#授权许可" class="header-anchor">#</a> 授权许可</h2> <p>授权许可是一个代表资源所有者授权（访问受保护资源）的凭据，客户端用它来获取访问令牌。</p> <p>OAuth 定义了四种许可类型——授权码、隐式许可、资源所有者密码凭据和客户端凭据——以及用于定义其他类型的可扩展性机制。</p> <h3 id="授权码-authorization-code"><a href="#授权码-authorization-code" class="header-anchor">#</a> 授权码 Authorization Code</h3> <p>grant_type：code</p> <p>授权码许可类型中，客户端不会直接向资源所有者申请授权，而是通过授权服务中介处理的。整个流程基于重定向，要求客户端必须能够与资源所有者的用户代理（通常是 web 浏览器）进行交互并能够接收来自授权服务器的传入请求（通过重定向）。</p> <div class="language-text extra-class"><pre class="language-text"><code>     +----------+
     | Resource |
     |   Owner  |
     |          |
     +----------+
          ^
          |
         (B)
     +----|-----+          Client Identifier      +---------------+
     |         -+----(A)-- &amp;amp; Redirection URI ----&gt;|               |
     |  User-   |                                 | Authorization |
     |  Agent  -+----(B)-- User authenticates ---&gt;|     Server    |
     |          |                                 |               |
     |         -+----(C)-- Authorization Code ---&amp;lt;|               |
     +-|----|---+                                 +---------------+
       |    |                                         ^      v
      (A)  (C)                                        |      |
       |    |                                         |      |
       ^    v                                         |      |
     +---------+                                      |      |
     |         |&gt;---(D)-- Authorization Code ---------'      |
     |  Client |          &amp;amp; Redirection URI                  |
     |         |                                             |
     |         |&amp;lt;---(E)----- Access Token -------------------'
     +---------+       (w/ Optional Refresh Token)
     
     						授权码流程图
</code></pre></div><p>注：说明步骤（A）、（B）和（C）的直线因为通过用户代理而被分为两部分。</p> <ul><li>（A）客户端通过将资源所有者的用户代理定向到授权端点来启动流程。 客户端包括其客户端标识符、请求的范围、本地状态和重定向URI，授权服务器将在授予(或拒绝)访问后将用户代理发送回该重定向URI。</li> <li>（B）授权服务器(通过用户代理)对资源所有者进行身份验证，并确定资源所有者是授予还是拒绝客户端的访问请求。</li> <li>（C）假设资源所有者授予访问权，授权服务器使用先前提供的重定向URI(在请求中或在客户端注册期间提供)将用户代理重定向回客户端。 重定向URI的参数中包括一个授权代码和前面客户机提供的任何本地状态。</li> <li>（D）客户端通过包含上一步中收到的授权码从授权服务器的令牌端点请求 access token。当发起请求时，客户端与授权服务器进行身份验证。客户端包含用于获得授权码的重定向URI来用于验证。</li> <li>（E）授权服务器对客户端进行身份验证，验证授权代码，并确保接收的重定向URI与在步骤（C）中用于重定向（资源所有者的用户代理）到客户端的URI相匹配。如果通过，授权服务器响应返回 access token 与可选的 refresh token</li></ul> <h4 id="授权请求"><a href="#授权请求" class="header-anchor">#</a> 授权请求</h4> <p>客户端向授权端点发起请求时，其 URI 中的 QueryString，必须添加以下参数</p> <table><thead><tr><th>参数</th> <th>必传</th> <th>描述</th></tr></thead> <tbody><tr><td>response_type</td> <td>是</td> <td>值必须是 &quot;code&quot;</td></tr> <tr><td>client_id</td> <td>是</td> <td>客户端标识</td></tr> <tr><td>redirect_uri</td> <td>否</td> <td>重定向地址，如果客户端在授权服务器中注册时已提供则可不传</td></tr> <tr><td>scope</td> <td>否</td> <td>请求访问的范围。</td></tr> <tr><td>state</td> <td>否</td> <td>推荐携带此值，用于防止跨站请求伪造</td></tr></tbody></table> <p>请求示例：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/authorize?response_type=code&amp;client_id=s6BhdRkqt3&amp;state=xyz&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">server.example.com</span></span>
</code></pre></div><p>授权服务器验证该请求，确保所有需要的参数已提交且有效。如果请求是有效的，授权服务器对资源所有者进行身份验证并获得授权决定（通过询问资源所有者或通过经由其他方式确定批准）。</p> <p>当确定决定后，授权服务器使用HTTP重定向响应向提供的客户端重定向URI定向用户代理，或者通过经由用户代理至该URI的其他可行方法。</p> <h4 id="授权响应"><a href="#授权响应" class="header-anchor">#</a> 授权响应</h4> <p>如果资源所有者许可访问请求，授权服务器颁发授权码，通过向重定向URI的查询部分添加下列参数传递授权码至客户端：</p> <table><thead><tr><th>参数</th> <th>必传</th> <th>描述</th></tr></thead> <tbody><tr><td>code</td> <td>是</td> <td>授权码必须在颁发后很快过期以减小泄露风险。推荐的最长的授权码生命周期是10分钟。客户端不能使用授权码超过一次。如果一个授权码被使用一次以上，授权服务器必须拒绝该请求并应该撤销（如可能）先前发出的基于该授权码的所有令牌。授权码与客户端标识和重定向URI绑定。</td></tr> <tr><td>state</td> <td>否</td> <td>当授权请求携带此参数时则必传，值原封不动回传</td></tr></tbody></table> <p>例如，授权服务器通过发送以下HTTP响应重定向用户代理：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">302</span> <span class="token reason-phrase string">Found</span></span>
<span class="token header"><span class="token header-name keyword">Location</span><span class="token punctuation">:</span> <span class="token header-value">https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA&amp;state=xyz</span></span>
</code></pre></div><p>客户端必须忽略无法识别的响应参数。 OAuth 未定义授权代码字符串的大小。 客户端应该避免对授权码的大小做出假设。 授权服务器应该记录它发出的任何值的大小。</p> <h4 id="访问令牌请求"><a href="#访问令牌请求" class="header-anchor">#</a> 访问令牌请求</h4> <p>客户端发起向授权服务器的令牌端点发起一个 POST 请求，其 Content-type 必须为 &quot;application/x-www-form-urlencoded&quot;，并在其请求体中需要包含以下参数：</p> <table><thead><tr><th>参数</th> <th>必传</th> <th>描述</th></tr></thead> <tbody><tr><td>grant_type</td> <td>是</td> <td>值必须是 &quot;authorization_code&quot;</td></tr> <tr><td>code</td> <td>是</td> <td>值为上一步从授权服务器中收到的授权码</td></tr> <tr><td>redirect_uri</td> <td>是</td> <td>如果授权请求中携带了redirect_uri参数，则这里的值必须其相同</td></tr> <tr><td>client_id</td> <td>是</td> <td>如果客户端没有和授权服务器进行过 Client Credentials 的身份验证，则必须携带</td></tr></tbody></table> <p>如果客户端类型为机密或客户端颁发了客户端凭据(或分配了其他认证要求)，则客户端必须向授权服务器进行 Client Credentials 的身份验证。</p> <p>例如：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/token</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">server.example.com</span></span>
<span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>

grant_type=authorization_code&amp;code=SplxlOBeZQQYbYS6WxSbIA
     &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb
</code></pre></div><p>授权服务器必须：</p> <ul><li>要求机密客户端或任何被颁发了客户端凭据（或有其他身份验证要求）的客户端进行客户端身份验证，</li> <li>若包括了客户端身份验证，验证客户端身份，</li> <li>确保授权码颁发给了通过身份验证的机密客户端，或者如果客户端是公开的，确保代码颁发给了请求中的&quot;client_id&quot;，</li> <li>验证授权码是有效的，并</li> <li>确保给出了 &quot;redirect_uri&quot; 参数，若 &quot;redirect_uri&quot; 参数包含在初始授权请求中，确保它们的值是相同的。</li></ul> <h4 id="访问令牌响应"><a href="#访问令牌响应" class="header-anchor">#</a> 访问令牌响应</h4> <p>如果访问令牌请求有效且已授权，授权服务器将发出访问令牌和可选的刷新令牌。 如果请求客户端认证失败或无效，授权服务器将返回一个错误响应。</p> <p>成功响应示例：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json;charset=UTF-8</span></span>
<span class="token header"><span class="token header-name keyword">Cache-Control</span><span class="token punctuation">:</span> <span class="token header-value">no-store</span></span>
<span class="token header"><span class="token header-name keyword">Pragma</span><span class="token punctuation">:</span> <span class="token header-value">no-cache</span></span>

{
    &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,
    &quot;token_type&quot;:&quot;example&quot;,
    &quot;expires_in&quot;:3600,
    &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;,
    &quot;example_parameter&quot;:&quot;example_value&quot;
}
</code></pre></div><h3 id="隐式授权-implicit"><a href="#隐式授权-implicit" class="header-anchor">#</a> 隐式授权 Implicit</h3> <p>grant_type：implicit</p> <p>隐式授权是为用如 JavaScript 等脚本语言在浏览器种实现的客户端而优化的一种简化的授权码流程。在隐式授权流程种，不再给客户端办法授权码，而是直接给客户端颁发一个 access token。</p> <div class="language-text extra-class"><pre class="language-text"><code>     +----------+
     | Resource |
     |  Owner   |
     |          |
     +----------+
          ^
          |
         (B)
     +----|-----+          Client Identifier     +---------------+
     |         -+----(A)-- &amp;amp; Redirection URI ---&gt;|               |
     |  User-   |                                | Authorization |
     |  Agent  -|----(B)-- User authenticates --&gt;|     Server    |
     |          |                                |               |
     |          |&amp;lt;---(C)--- Redirection URI ----&amp;lt;|               |
     |          |          with Access Token     +---------------+
     |          |            in Fragment
     |          |                                +---------------+
     |          |----(D)--- Redirection URI ----&gt;|   Web-Hosted  |
     |          |          without Fragment      |     Client    |
     |          |                                |    Resource   |
     |     (F)  |&amp;lt;---(E)------- Script ---------&amp;lt;|               |
     |          |                                +---------------+
     +-|--------+
       |    |
      (A)  (G) Access Token
       |    |
       ^    v
     +---------+
     |         |
     |  Client |
     |         |
     +---------+
</code></pre></div><ul><li>(A) 客户端通过将资源所有者的用户代理定向到授权端点来启动流程。 客户端包括其客户端标识符、请求的范围、本地状态和重定向URI，授权服务器将在授予(或拒绝)访问后将用户代理发送回该重定向URI。</li> <li>(B) 授权服务器(通过用户代理)对资源所有者进行身份验证，并确定资源所有者是授予还是拒绝客户端的访问请求。</li> <li>(C) 假设资源所有者授予访问权，授权服务器使用先前提供的重定向URI(在请求中或在客户端注册期间提供)将用户代理重定向回客户端。 <strong>重定向URI 的 Hash</strong> 中将包含 access token。</li> <li>(D) 用户代理遵循重定向指令，向 web-hosted 的客户端资源发出请求（根据 [RFC2616]，URI 中的 Hash 部分不会携带在请求 URI 中携带）。用户代理将 Hash 中的参数取出并保存。</li> <li>(E) web-hosted 的客户端资源返回一个web页面(通常是一个带有嵌入式脚本的HTML文档)，该页面能够访问完整的重定向URI，包括用户代理保留的片段，并提取片段中包含的访问令牌(和其他参数)。</li> <li>(F) 用户代理在本地执行由 web-hosted 的客户端资源提供的脚本，从而提取访问令牌。</li> <li>(G) 用户代理将访问令牌传递给客户端。</li></ul> <blockquote><p>(D) (E) 为非必选步骤，主要用于当用户代理不支持在 response header 的 Location 属性中包含 Hash 片段时，通过返回一个内嵌 javascript 的 html 页面，页面内引导用户点击按钮跳转向 redirect_url</p></blockquote> <h4 id="授权请求-2"><a href="#授权请求-2" class="header-anchor">#</a> 授权请求</h4> <p>客户端向授权端点发起请求时，其 URI 中的 QueryString，必须添加以下参数</p> <table><thead><tr><th>参数</th> <th>必传</th> <th>描述</th></tr></thead> <tbody><tr><td>response_type</td> <td>是</td> <td>值必须是 &quot;token&quot;</td></tr> <tr><td>client_id</td> <td>是</td> <td>客户端标识</td></tr> <tr><td>redirect_uri</td> <td>否</td> <td>重定向地址，如果客户端在授权服务器中注册时已提供则可不传</td></tr> <tr><td>scope</td> <td>否</td> <td>请求访问的范围。</td></tr> <tr><td>state</td> <td>否</td> <td>推荐携带此值，用于防止跨站请求伪造</td></tr></tbody></table> <p>请求示例：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token request-line"><span class="token method property">GET</span> <span class="token request-target url">/authorize?response_type=token&amp;client_id=s6BhdRkqt3&amp;state=xyz&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">server.example.com</span></span>
</code></pre></div><p>授权服务器验证该请求，确保所有需要的参数已提交且有效。授权服务器必须验证它将访问令牌重定向到的重定向URI与客户端注册的重定向URI匹配。</p> <p>如果请求是有效的，授权服务器对资源所有者进行身份验证并获得授权决定（通过询问资源所有者或通过经由其他方式确定批准）。</p> <p>当确定决定后，授权服务器使用HTTP重定向响应向提供的客户端重定向URI定向用户代理，或者通过经由用户代理至该URI的其他可行方法。</p> <h4 id="授权响应-2"><a href="#授权响应-2" class="header-anchor">#</a> 授权响应</h4> <p>如果资源所有者许可访问请求，授权服务器直接颁发访问令牌，通过向重定向URI的 Hash 部分添加下列参数传递 access token 至客户端：</p> <table><thead><tr><th>参数</th> <th>必传</th> <th>描述</th></tr></thead> <tbody><tr><td>access_token</td> <td>是</td> <td>授权服务器颁发的访问令牌。</td></tr> <tr><td>token_type</td> <td>是</td> <td>颁发的令牌的类型，其值是大小写不敏感的。（一般是 Bearer）</td></tr> <tr><td>expires_in</td> <td>否</td> <td>推荐的。以秒为单位的访问令牌生命周期。例如，值&quot;3600&quot;表示访问令牌将在从生成响应时的1小时后到期。如果省略，则授权服务器应该通过其他方式提供过期时间，或者记录默认值。</td></tr> <tr><td>scope</td> <td>否</td> <td>若与客户端请求的 scope 范围相同则可以不传，否则必需返回此值。</td></tr> <tr><td>state</td> <td>否</td> <td>当授权请求携带此参数时则必传，值原封不动回传</td></tr></tbody></table> <p>例如，授权服务器通过发送以下HTTP响应重定向用户代理：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">302</span> <span class="token reason-phrase string">Found</span></span>
<span class="token header"><span class="token header-name keyword">Location</span><span class="token punctuation">:</span> <span class="token header-value">http://example.com/cb#access_token=2YotnFZFEjr1zCsicMWpAA&amp;state=xyz&amp;token_type=example&amp;expires_in=3600</span></span>
</code></pre></div><p>开发人员应注意，一些用户代理不支持在HTTP&quot;Location&quot;HTTP响应标头字段中包含片段组成部分。这些客户端需要使用除了3xx重定向响应以外的其他方法来重定向客户端——-例如，返回一个HTML页面，其中包含一个具有链接到重定向URI的动作的&quot;继续&quot;按钮。</p> <p>客户端必须忽略无法识别的响应参数。 OAuth 未定义授权代码字符串的大小。 客户端应该避免对授权码的大小做出假设。 授权服务器应该记录它发出的任何值的大小。</p> <h3 id="资源所有者密码凭证-resource-owner-password-credentials"><a href="#资源所有者密码凭证-resource-owner-password-credentials" class="header-anchor">#</a> 资源所有者密码凭证 Resource Owner Password Credentials</h3> <p>grant_type：password</p> <p>资源所有者密码凭据许可类型适合于资源所有者与客户端具有信任关系的情况，如设备操作系统或高级特权应用。当启用这种许可类型时授权服务器应该特别关照且只有当其他流程都不可用时才可以。</p> <p>这种许可类型适合于能够获得资源所有者凭据（用户名和密码，通常使用交互的形式）的客户端。通过转换已存储的凭据至访问令牌，它也用于迁移现存的使用如HTTP基本或摘要身份验证的直接身份验证方案的客户端至OAuth。</p> <div class="language-text extra-class"><pre class="language-text"><code>     +----------+
     | Resource |
     |  Owner   |
     |          |
     +----------+
          v
          |    Resource Owner
         (A) Password Credentials
          |
          v
     +---------+                                  +---------------+
     |         |&gt;--(B)---- Resource Owner -------&gt;|               |
     |         |         Password Credentials     | Authorization |
     | Client  |                                  |     Server    |
     |         |&amp;lt;--(C)---- Access Token ---------&amp;lt;|               |
     |         |    (w/ Optional Refresh Token)   |               |
     +---------+                                  +---------------+
</code></pre></div><ul><li>(A) 资源所有者提供给客户端它的用户名和密码。</li> <li>(B) 通过包含从资源所有者处接收到的凭据，客户端从授权服务器的令牌端点请求访问令牌。当发起请求时，客户端与授权服务器进行身份验证。</li> <li>(C) 授权服务器对客户端进行身份验证，验证资源所有者的凭证，如果有效，颁发访问令牌。</li></ul> <h4 id="授权请求和响应"><a href="#授权请求和响应" class="header-anchor">#</a> 授权请求和响应</h4> <p>客户端获取资源所有者凭据 (用户名/密码) 的方法超出了本规范的范围。 一旦获得了访问令牌，客户端必须丢弃凭据。</p> <h4 id="访问令牌请求-2"><a href="#访问令牌请求-2" class="header-anchor">#</a> 访问令牌请求</h4> <p>客户端向授权服务器的令牌端点发起一个 POST 请求，其 Content-type 必须为 &quot;application/x-www-form-urlencoded&quot;，并在其请求体中需要包含以下参数：</p> <table><thead><tr><th>参数</th> <th>必传</th> <th>描述</th></tr></thead> <tbody><tr><td>grant_type</td> <td>是</td> <td>值必须是 &quot;password&quot;</td></tr> <tr><td>username</td> <td>是</td> <td>资源所有者的用户名。</td></tr> <tr><td>password</td> <td>是</td> <td>资源所有者的密码。</td></tr> <tr><td>scope</td> <td>是</td> <td>请求访问的范围</td></tr></tbody></table> <p>如果客户端类型是机密的或客户端被颁发了客户端凭据，则客户端必须要与授权服务器进行身份验证（request header 中携带 Authorization，值为 Base64(clientId:clientSecret) ）。</p> <p>例如：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/token</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">server.example.com</span></span>
<span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>
grant_type=password&amp;username=johndoe&amp;password=A3ddj3w
</code></pre></div><p>授权服务器必须：</p> <ul><li>要求机密客户端或任何被颁发了客户端凭据（或有其他身份验证要求）的客户端进行客户端身份验证，</li> <li>若包括了客户端身份验证，验证客户端身份</li> <li>使用它现有的密码验证算法验证资源所有者的密码凭据。</li></ul> <p>由于这种访问令牌请求使用了资源所有者的密码，授权服务器必须保护端点防止暴力攻击（例如，使用速率限制或生成警报）。</p> <h4 id="访问令牌响应-2"><a href="#访问令牌响应-2" class="header-anchor">#</a> 访问令牌响应</h4> <p>如果访问令牌请求有效且已授权，授权服务器将发出访问令牌和可选的刷新令牌。 如果请求客户端认证失败或无效，授权服务器将返回一个错误响应。 一个成功响应的示例如下:</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json;charset=UTF-8</span></span>
<span class="token header"><span class="token header-name keyword">Cache-Control</span><span class="token punctuation">:</span> <span class="token header-value">no-store</span></span>
<span class="token header"><span class="token header-name keyword">Pragma</span><span class="token punctuation">:</span> <span class="token header-value">no-cache</span></span>

{
  &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,
  &quot;token_type&quot;:&quot;example&quot;,
  &quot;expires_in&quot;:3600,
  &quot;refresh_token&quot;:&quot;tGzv3JOkF0XG5Qx2TlKWIA&quot;,
  &quot;example_parameter&quot;:&quot;example_value&quot;
}
</code></pre></div><h3 id="客户端凭证-client-credentials"><a href="#客户端凭证-client-credentials" class="header-anchor">#</a> 客户端凭证 Client Credentials</h3> <p>grant_type: client_credentials</p> <p>当客户端请求访问它所控制的，或者事先与授权服务器协商（所采用的方法超出了本规范的范围）的其他资源所有者的受保护资源，客户端可以只使用它的客户端凭据（或者其他受支持的身份验证方法）请求访问令牌。</p> <p>客户端凭据许可类型必须只能由机密客户端使用。</p> <div class="language-text extra-class"><pre class="language-text"><code>     +---------+                                  +---------------+
     |         |                                  |               |
     |         |&gt;--(A)- Client Authentication ---&gt;| Authorization |
     | Client  |                                  |     Server    |
     |         |&amp;lt;--(B)---- Access Token ---------&amp;lt;|               |
     |         |                                  |               |
     +---------+                                  +---------------+
</code></pre></div><ul><li>（A）客户端与授权服务器进行身份验证并向令牌端点请求访问令牌。</li> <li>（B）授权服务器对客户端进行身份验证，如果有效，颁发访问令牌。</li></ul> <h4 id="授权请求和响应-2"><a href="#授权请求和响应-2" class="header-anchor">#</a> 授权请求和响应</h4> <p>由于客户端身份验证被用作授权许可，所以不需要其他授权请求。</p> <h4 id="访问令牌请求-3"><a href="#访问令牌请求-3" class="header-anchor">#</a> 访问令牌请求</h4> <p>客户端向授权服务器的令牌端点发起一个 POST 请求，其 Content-type 必须为 &quot;application/x-www-form-urlencoded&quot;，并在其请求体中需要包含以下参数：</p> <table><thead><tr><th>参数</th> <th>必传</th> <th>描述</th></tr></thead> <tbody><tr><td>grant_type</td> <td>是</td> <td>值必须是 &quot;client_credentials&quot;</td></tr> <tr><td>scope</td> <td>是</td> <td>请求访问的范围</td></tr></tbody></table> <p>一个请求示例如下：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/token</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">server.example.com</span></span>
<span class="token header"><span class="token header-name keyword">Authorization</span><span class="token punctuation">:</span> <span class="token header-value">Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/x-www-form-urlencoded</span></span>

grant_type=client_credentials
</code></pre></div><p>授权服务器必须验证客户端身份。</p> <h4 id="访问令牌响应-3"><a href="#访问令牌响应-3" class="header-anchor">#</a> 访问令牌响应</h4> <p>如果访问令牌请求有效且已授权，授权服务器将发出访问令牌，但并不包含刷新令牌。 如果请求客户端认证失败或无效，授权服务器将返回一个错误响应。</p> <p>一个成功响应的示例如下:</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token response-status"><span class="token http-version property">HTTP/1.1</span> <span class="token status-code number">200</span> <span class="token reason-phrase string">OK</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/json;charset=UTF-8</span></span>
<span class="token header"><span class="token header-name keyword">Cache-Control</span><span class="token punctuation">:</span> <span class="token header-value">no-store</span></span>
<span class="token header"><span class="token header-name keyword">Pragma</span><span class="token punctuation">:</span> <span class="token header-value">no-cache</span></span>

{
    &quot;access_token&quot;:&quot;2YotnFZFEjr1zCsicMWpAA&quot;,
    &quot;token_type&quot;:&quot;example&quot;,
    &quot;expires_in&quot;:3600,
    &quot;example_parameter&quot;:&quot;example_value&quot;
}
</code></pre></div><h2 id="一、授权服务器"><a href="#一、授权服务器" class="header-anchor">#</a> 一、授权服务器</h2> <h3 id="_1-依赖引入"><a href="#_1-依赖引入" class="header-anchor">#</a> 1.依赖引入</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.lovecyy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>relaxed-auth<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_2-配置客户端信息"><a href="#_2-配置客户端信息" class="header-anchor">#</a> 2.配置客户端信息</h3> <blockquote><p>默认是jdbc形式,参见<code>oauth_client_details</code>，演示使用内存模式</p></blockquote> <ul><li><strong>InmemoryOauth2ClientConfigurer</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InmemoryOauth2ClientConfigurer</span> <span class="token keyword">implements</span> <span class="token class-name">OAuth2ClientConfigurer</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
		clients<span class="token punctuation">.</span><span class="token function">inMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withClient</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token comment">// 配置client_id</span>
				<span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span><span class="token class-name">PasswordUtils</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;admin123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 配置client_secret</span>
				<span class="token punctuation">.</span><span class="token function">accessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token comment">// 配置访问token的有效期</span>
				<span class="token punctuation">.</span><span class="token function">refreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">864000</span><span class="token punctuation">)</span><span class="token comment">// 配置刷新token的有效期</span>
				<span class="token punctuation">.</span><span class="token function">redirectUris</span><span class="token punctuation">(</span><span class="token string">&quot;http://www.baidu.com&quot;</span><span class="token punctuation">)</span><span class="token comment">// 配置redirect_uri，用于授权成功后跳转</span>
				<span class="token punctuation">.</span><span class="token function">scopes</span><span class="token punctuation">(</span><span class="token string">&quot;server&quot;</span><span class="token punctuation">)</span><span class="token comment">// 配置申请的权限范围</span>
				<span class="token punctuation">.</span><span class="token function">authorizedGrantTypes</span><span class="token punctuation">(</span><span class="token string">&quot;authorization_code&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;refresh_token&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">autoApprove</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment">// 配置grant_type，表示授权类型</span>
				<span class="token punctuation">.</span><span class="token function">resourceIds</span><span class="token punctuation">(</span><span class="token string">&quot;test-server&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tes&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withClient</span><span class="token punctuation">(</span><span class="token string">&quot;resource&quot;</span><span class="token punctuation">)</span><span class="token comment">// 配置client_id</span>
				<span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span><span class="token class-name">PasswordUtils</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;resource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 配置client_secret</span>
				<span class="token punctuation">.</span><span class="token function">accessTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token comment">// 配置访问token的有效期</span>
				<span class="token punctuation">.</span><span class="token function">refreshTokenValiditySeconds</span><span class="token punctuation">(</span><span class="token number">864000</span><span class="token punctuation">)</span><span class="token comment">// 配置刷新token的有效期</span>
				<span class="token punctuation">.</span><span class="token function">redirectUris</span><span class="token punctuation">(</span><span class="token string">&quot;http://www.baidu.com&quot;</span><span class="token punctuation">)</span><span class="token comment">// 配置redirect_uri，用于授权成功后跳转</span>
				<span class="token punctuation">.</span><span class="token function">scopes</span><span class="token punctuation">(</span><span class="token string">&quot;server&quot;</span><span class="token punctuation">)</span><span class="token comment">// 配置申请的权限范围</span>
				<span class="token punctuation">.</span><span class="token function">authorizedGrantTypes</span><span class="token punctuation">(</span><span class="token string">&quot;authorization_code&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;refresh_token&quot;</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">autoApprove</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token comment">// 配置grant_type，表示授权类型</span>
		<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><ul><li><strong>客户端Bean注册</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code>	
<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">OAuth2ClientConfigurer</span> <span class="token function">oAuth2ClientConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InmemoryOauth2ClientConfigurer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-配置令牌存储"><a href="#_3-配置令牌存储" class="header-anchor">#</a> 3.配置令牌存储</h3> <blockquote><p>建议使用redis，jdbc或jwt形式，默认采用内存模式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token comment">/**
	 * 令牌存储
	 * @return
	 */</span>
	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InMemoryTokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-配置token增强-可选"><a href="#_4-配置token增强-可选" class="header-anchor">#</a> 4.配置Token增强(可选)</h3> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token comment">/**
	 * 配置token增强 可以附加扩展信息
	 */</span>
	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">ExtendTokenEnhancer</span> <span class="token function">extendTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ExtendTokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExtendTokenEnhancer</span> <span class="token keyword">implements</span> <span class="token class-name">TokenEnhancer</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">OAuth2AccessToken</span> <span class="token function">enhance</span><span class="token punctuation">(</span><span class="token class-name">OAuth2AccessToken</span> oAuth2AccessToken<span class="token punctuation">,</span> <span class="token class-name">OAuth2Authentication</span> oAuth2Authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> info <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		info<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;enhance&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;enhance info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultOAuth2AccessToken</span><span class="token punctuation">)</span> oAuth2AccessToken<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAdditionalInformation</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> oAuth2AccessToken<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>



</code></pre></div><h3 id="_5-配置用户信息服务"><a href="#_5-配置用户信息服务" class="header-anchor">#</a> 5.配置用户信息服务</h3> <blockquote><p>继承UserDetailsService</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span>  <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userList<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@PostConstruct</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token class-name">PasswordUtils</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		userList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		userList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;macro&quot;</span><span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		userList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;andy&quot;</span><span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		userList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;mark&quot;</span><span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> findUserList <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>findUserList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">User</span> user <span class="token operator">=</span> findUserList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">User</span> user1 <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">cloneByStream</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">;</span>
			<span class="token keyword">return</span> user1<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">&quot;用户名或密码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-开启授权服务器"><a href="#_6-开启授权服务器" class="header-anchor">#</a> 6.开启授权服务器</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableOauth2AuthorizationServer</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthDemoApplication</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">AuthDemoApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h2 id="二、资源服务器"><a href="#二、资源服务器" class="header-anchor">#</a> 二、资源服务器</h2> <h3 id="_1-依赖引入-2"><a href="#_1-依赖引入-2" class="header-anchor">#</a> 1.依赖引入</h3> <div class="language-xml extra-class"><pre class="language-xml"><code>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.lovecyy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>relaxed-resource<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="_2-application-yml"><a href="#_2-application-yml" class="header-anchor">#</a> 2.application.yml</h3> <blockquote><p>若授权服务器和资源服务器在同一项目,则只需要配置<code>extension</code></p></blockquote> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment">#指定授权服务器地址</span>
<span class="token key atrule">auth-server-address</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">9401</span>
<span class="token key atrule">security</span><span class="token punctuation">:</span>
  <span class="token key atrule">oauth2</span><span class="token punctuation">:</span>
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
      <span class="token key atrule">client-id</span><span class="token punctuation">:</span> admin
      <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> admin123456
      <span class="token key atrule">access-token-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>auth<span class="token punctuation">-</span>server<span class="token punctuation">-</span>address<span class="token punctuation">}</span>/oauth/token
      <span class="token key atrule">user-authorization-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>auth<span class="token punctuation">-</span>server<span class="token punctuation">-</span>address<span class="token punctuation">}</span>/oauth/authorize
    <span class="token key atrule">resource</span><span class="token punctuation">:</span>
      <span class="token comment">#自省token地址</span>
      <span class="token key atrule">token-info-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>auth<span class="token punctuation">-</span>server<span class="token punctuation">-</span>address<span class="token punctuation">}</span>/oauth/check_token
    <span class="token key atrule">extension</span><span class="token punctuation">:</span>
      <span class="token comment">#资源服务标识</span>
      <span class="token key atrule">resourceId</span><span class="token punctuation">:</span> order
      <span class="token comment">#忽略鉴权url</span>
      <span class="token key atrule">ignoreUrls</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> /user/<span class="token important">**</span>
</code></pre></div><h3 id="_3-开启资源服务器"><a href="#_3-开启资源服务器" class="header-anchor">#</a> 3.开启资源服务器</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableOauth2ResourceServer</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthDemoApplication</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">AuthDemoApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="三、使用方式"><a href="#三、使用方式" class="header-anchor">#</a> 三、使用方式</h2> <blockquote><p>访问Token请求，若请求参数包含client_id，则走<code>ClientCredentialsTokenEndpointFilter</code>   否则走<code>BasicAuthenticationFilter</code></p></blockquote> <h3 id="_1-授权码模式"><a href="#_1-授权码模式" class="header-anchor">#</a> 1.授权码模式</h3> <blockquote><p>grant_type=authorization_code</p></blockquote> <ul><li><p>启动授权服务器；</p></li> <li><p>在浏览器访问该地址进行登录授权：http://localhost:9401/oauth/authorize?response_type=code&amp;client_id=admin&amp;redirect_uri=http://www.baidu.com&amp;scope=all&amp;state=normal</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/%E6%8E%88%E6%9D%83%E7%A0%81%E7%99%BB%E5%BD%95.png" alt=""></p></li> <li><p>输入账号密码进行登录操作：</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/%E7%A1%AE%E8%AE%A4%E6%8E%88%E6%9D%83%E9%A1%B5.png" alt=""></p></li> <li><p>之后会浏览器会带着授权码跳转到我们指定的路径：</p></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>https://www.baidu.com/?code<span class="token operator">=</span>eTsADY<span class="token operator">&amp;</span><span class="token assign-left variable">state</span><span class="token operator">=</span>normal
</code></pre></div><ul><li><p>使用授权码请求该地址获取访问令牌：http://localhost:9401/oauth/token</p></li> <li><p>使用Basic认证通过client_id和client_secret构造一个Authorization头信息；</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/Basic%E8%AE%A4%E8%AF%81.png" alt=""></p></li> <li><p>在body中添加以下参数信息，通过POST请求获取访问令牌；</p></li></ul> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/%E6%8E%88%E6%9D%83%E7%A0%81%E6%A8%A1%E5%BC%8F.png" alt=""></p> <h3 id="_2-密码模式"><a href="#_2-密码模式" class="header-anchor">#</a> 2.密码模式</h3> <blockquote><p>grant_type=password</p></blockquote> <ul><li><p>使用密码请求该地址获取访问令牌：http://localhost:9401/oauth/token</p></li> <li><p>使用Basic认证通过client_id和client_secret构造一个Authorization头信息，</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/Basic%E8%AE%A4%E8%AF%81.png" alt=""></p> <p>若客户端请求没有Basic Auth 则直接在请求头输入如下参数</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Authorization</span><span class="token operator">:</span> <span class="token class-name">Basic</span> dWk6dWk<span class="token operator">=</span>
dWk6dWk计算方式如下
<span class="token punctuation">(</span>clientId<span class="token operator">:</span>clientSecret<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encodeBase64</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>在body中添加以下参数信息，通过POST请求获取访问令牌；</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F.png" alt=""></p></li></ul> <ul><li><p>在请求头中添加访问令牌，访问需要登录认证的接口进行测试，发现已经可以成功访问：http://localhost:9401/user/getCurrentUser</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/%E8%AE%BF%E9%97%AE%E6%8E%A5%E5%8F%A3.png" alt=""></p></li></ul> <h3 id="_3-implicit-简化模式"><a href="#_3-implicit-简化模式" class="header-anchor">#</a> 3.Implicit（简化模式）</h3> <blockquote><p>grant_type=implicit</p></blockquote> <ul><li><p>直接浏览器发起请求 http://localhost:9401/oauth/authorize?response_type=token&amp;client_id=admin&amp;redirect_uri=http://www.baidu.com&amp;scope=server&amp;state=normal</p></li> <li><p>会在重定向url#hash带上accesss_token</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/%E7%AE%80%E5%8C%96%E6%A8%A1%E5%BC%8F.png" alt=""></p></li></ul> <h3 id="_4-客户端凭证"><a href="#_4-客户端凭证" class="header-anchor">#</a> 4.客户端凭证</h3> <blockquote><p>grant_type=client_credentials</p></blockquote> <ul><li><p>使用客户端凭证请求该地址获取访问令牌：http://localhost:9401/oauth/token</p></li> <li><p>使用Basic认证通过client_id和client_secret构造一个Authorization头信息，</p></li></ul> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/Basic%E8%AE%A4%E8%AF%81.png" alt=""></p> <ul><li><p>在body中添加以下参数信息，通过POST请求获取访问令牌；</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A8%A1%E5%BC%8F.png" alt=""></p></li></ul> <h3 id="_5-刷新token"><a href="#_5-刷新token" class="header-anchor">#</a> 5.刷新Token</h3> <blockquote><p>grant_type=refresh_token</p></blockquote> <ul><li><p>使用客户端凭证请求该地址获取访问令牌：http://localhost:9401/oauth/token</p></li> <li><p>使用Basic认证通过client_id和client_secret构造一个Authorization头信息，</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/Basic%E8%AE%A4%E8%AF%81.png" alt=""></p></li></ul> <ul><li><p>在body中添加以下参数信息，通过POST请求获取访问令牌；</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/20220726164212.png" alt=""></p></li></ul> <h1 id="附"><a href="#附" class="header-anchor">#</a> 附:</h1> <h2 id="一、附带sql"><a href="#一、附带sql" class="header-anchor">#</a> 一、附带sql</h2> <h3 id="_1-oauth-client-details"><a href="#_1-oauth-client-details" class="header-anchor">#</a> 1.oauth_client_details</h3> <p>授权码 主要操作<code>oauth_client_details</code>表的类是<code>JdbcClientDetailsService.java</code></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'客户端标识'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>resource_ids<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'接入资源列表'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>client_secret<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'客户端秘钥'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>scope<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> 
  <span class="token identifier"><span class="token punctuation">`</span>authorized_grant_types<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>web_server_redirect_uri<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>authorities<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>access_token_validity<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>refresh_token_validity<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>additional_information<span class="token punctuation">`</span></span> <span class="token keyword">longtext</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>archived<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>trusted<span class="token punctuation">`</span></span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>autoapprove<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 ROW_FORMAT<span class="token operator">=</span>DYNAMIC <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'接入客户端信息'</span><span class="token punctuation">;</span>

</code></pre></div><table><thead><tr><th>字段名</th> <th>类型</th> <th>描述</th></tr></thead> <tbody><tr><td>client_id</td> <td>varchar</td> <td>主键,必须唯一,不能为空. 用于唯一标识每一个客户端(client);</td></tr> <tr><td>resource_ids</td> <td>varchar</td> <td>客户端所能访问的资源id集合,多个资源时用逗号(,),如果没设置，就是对所有的Resource Server都有访问权限。</td></tr> <tr><td>client_secret</td> <td>varchar</td> <td>用于指定客户端(client)的访问密匙</td></tr> <tr><td>scope</td> <td>varchar</td> <td>指定客户端申请的权限范围,可选值包括read,write,trust,all(可自定义）;若有多个权限范围用逗号(,)分隔,@EnableGlobalMethodSecurity(prePostEnabled = true)启用方法级权限控制</td></tr> <tr><td>authorized_grant_types</td> <td>varchar</td> <td>然后在方法上注解标识@PreAuthorize(&quot;#oauth2.hasScope('read')&quot;)就是5种授权模式：authorization_code,password,refresh_token,implicit,client_credentials, 若支持多个grant_type用逗号(,)分隔,</td></tr> <tr><td>web_server_redirect_uri</td> <td>varchar</td> <td>重定向地址，在oauth中会校验</td></tr> <tr><td>authorities</td> <td>varchar</td> <td>指定客户端所拥有的权限值,可选, 若有多个权限值,用逗号(,)分隔。若授权模式中不需要账户密码的建议设；若授权模式需要账户密码的，可以不设立</td></tr> <tr><td>access_token_validity</td> <td>int</td> <td>设定客户端的access_token的有效时间值(单位:秒) 【默认12小时】</td></tr> <tr><td>refresh_token_validity</td> <td>int</td> <td>设定客户端的refresh_token的有效时间值(单位:秒）【默认30天】</td></tr> <tr><td>additional_information</td> <td>longtext</td> <td>可以额外附带的信息，若赋值，则需要json规范</td></tr> <tr><td>create_time</td> <td>timestamp</td> <td>数据的创建时间,精确到秒,由数据库在插入数据时取当前系统时间自动生成(扩展字段)</td></tr> <tr><td>archived</td> <td>tinyint</td> <td>标识是否存档，默认为0</td></tr> <tr><td>trusted</td> <td>tinyint</td> <td>标识是否受信任，默认0（0-不信任，1-信任）</td></tr> <tr><td>autoapprove</td> <td>varchar</td> <td>设置用户是否自动Approval操作，通常只在authorization_code 模式有效</td></tr></tbody></table> <h3 id="_2-oauth-code"><a href="#_2-oauth-code" class="header-anchor">#</a> 2.oauth_code</h3> <p>支持授权码获取accessToken</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_code<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>code<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>authentication<span class="token punctuation">`</span></span> <span class="token keyword">BLOB</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
<span class="token keyword">DEFAULT</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>

</code></pre></div><h3 id="_3-oauth-access-token"><a href="#_3-oauth-access-token" class="header-anchor">#</a> 3.oauth_access_token</h3> <p>对<code>oauth_client_token</code>表的主要操作在<code>JdbcClientTokenServices.java</code>，实际上未使用到</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_access_token<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>token_id<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>token<span class="token punctuation">`</span></span> <span class="token keyword">BLOB</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>authentication_id<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_name<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>authentication<span class="token punctuation">`</span></span> <span class="token keyword">BLOB</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>refresh_token<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>authentication_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
<span class="token keyword">DEFAULT</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>

</code></pre></div><table><thead><tr><th>字段名</th> <th>类型</th> <th>描述</th></tr></thead> <tbody><tr><td>token_id</td> <td>varchar</td> <td>从服务器端获取到的access_token的值.</td></tr> <tr><td>token</td> <td>BLOB</td> <td>这是一个二进制的字段, 存储的数据OAuth2AccessToken.java对象序列化后的二进制数据.</td></tr> <tr><td>authentication_id</td> <td>varchar</td> <td>该字段具有唯一性, 是根据当前的username(如果有),client_id与scope通过MD5加密生成的. 具体实现请参考DefaultClientKeyGenerator.java类.</td></tr> <tr><td>user_name</td> <td>varchar</td> <td>登录时的用户名</td></tr> <tr><td>client_id</td> <td>varchar</td> <td>主键,必须唯一,不能为空. 用于唯一标识每一个客户端(client);</td></tr> <tr><td>authentication</td> <td>varchar</td> <td>存储将OAuth2Authentication.java对象序列化后的二进制数据.</td></tr> <tr><td>refresh_token</td> <td>varchar</td> <td>该字段的值是将refresh_token的值通过MD5加密后存储的.</td></tr></tbody></table> <h3 id="_4-oauth-refresh-token"><a href="#_4-oauth-refresh-token" class="header-anchor">#</a> 4.oauth_refresh_token</h3> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>oauth_refresh_token<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>token_id<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>token<span class="token punctuation">`</span></span> <span class="token keyword">BLOB</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>authentication<span class="token punctuation">`</span></span> <span class="token keyword">BLOB</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span>
<span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span>
<span class="token keyword">DEFAULT</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8<span class="token punctuation">;</span>

</code></pre></div><table><thead><tr><th>字段名</th> <th>类型</th> <th>描述</th></tr></thead> <tbody><tr><td>token_id</td> <td>varchar</td> <td>从服务器端获取到的access_token的值.</td></tr> <tr><td>token</td> <td>BLOB</td> <td>这是一个二进制的字段, 存储的数据OAuth2AccessToken.java对象序列化后的二进制数据.</td></tr> <tr><td>authentication</td> <td>varchar</td> <td>存储将OAuth2Authentication.java对象序列化后的二进制数据.</td></tr></tbody></table> <h2 id="二、扩展授权服务器"><a href="#二、扩展授权服务器" class="header-anchor">#</a> 二、扩展授权服务器</h2> <h3 id="内置扩展器"><a href="#内置扩展器" class="header-anchor">#</a> 内置扩展器</h3> <h4 id="实现扩展用户信息服务"><a href="#实现扩展用户信息服务" class="header-anchor">#</a> 实现扩展用户信息服务</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">implements</span> <span class="token class-name">ExtendUserDetailsService</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> userList<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@PostConstruct</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token class-name">PasswordUtils</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		userList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		userList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;macro&quot;</span><span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		userList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;andy&quot;</span><span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		userList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;mark&quot;</span><span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> findUserList <span class="token operator">=</span> userList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>user <span class="token operator">-&gt;</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>findUserList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">User</span> user <span class="token operator">=</span> findUserList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">User</span> user1 <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">cloneByStream</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">;</span>
			<span class="token keyword">return</span> user1<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">&quot;用户名或密码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loginByMobile</span><span class="token punctuation">(</span><span class="token class-name">String</span> mobile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token class-name">PasswordUtils</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;macro&quot;</span><span class="token punctuation">,</span> password<span class="token punctuation">,</span> <span class="token class-name">AuthorityUtils</span><span class="token punctuation">.</span><span class="token function">commaSeparatedStringToAuthorityList</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="验证码登录"><a href="#验证码登录" class="header-anchor">#</a> 验证码登录</h4> <blockquote><p>请求授权类型 grant_type = captcha</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomCaptchaValidator</span> <span class="token keyword">implements</span> <span class="token class-name">CaptchaValidator</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> parameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 取出验证码</span>
		<span class="token class-name">String</span> validateCode <span class="token operator">=</span> parameters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>validateCode<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;验证码不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
		<span class="token class-name">String</span> validateCodeKey <span class="token operator">=</span> <span class="token string">&quot;CAPTCHA:&quot;</span> <span class="token operator">+</span> uuid<span class="token punctuation">;</span>
		<span class="token comment">// 从缓存取出正确的验证码和用户输入的验证码比对</span>
		<span class="token class-name">String</span> correctValidateCode <span class="token operator">=</span> <span class="token constant">CACHE</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>validateCodeKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>correctValidateCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidGrantException</span><span class="token punctuation">(</span><span class="token string">&quot;验证码已过期&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validateCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>correctValidateCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidGrantException</span><span class="token punctuation">(</span><span class="token string">&quot;您输入的验证码不正确&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 验证码验证通过，删除 Redis 的验证码</span>
		<span class="token constant">CACHE</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>validateCodeKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 移除后续无用参数</span>
		parameters<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="手机号登录"><a href="#手机号登录" class="header-anchor">#</a> 手机号登录</h4> <blockquote><p>请求授权类型 grant_type = sms_code</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomSmsCodeValidator</span> <span class="token keyword">implements</span> <span class="token class-name">SmsCodeValidator</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">String</span> mobile<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>code<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;666666&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 666666 是后门，因为短信收费，正式环境删除这个if分支</span>
			<span class="token comment">// 短信验证码key前缀</span>
			<span class="token class-name">String</span> codeKey <span class="token operator">=</span> <span class="token string">&quot;SMS_CODE:&quot;</span> <span class="token operator">+</span> mobile<span class="token punctuation">;</span>
			<span class="token comment">// 根据验证码key获取验证码</span>
			<span class="token class-name">String</span> correctCode <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
			<span class="token comment">// 验证码比对</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>correctCode<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>code<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>correctCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidGrantException</span><span class="token punctuation">(</span><span class="token string">&quot;验证码不正确&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 比对成功删除缓存的验证码</span>
			<span class="token comment">// ...del</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h3 id="拓展扩展器"><a href="#拓展扩展器" class="header-anchor">#</a> 拓展扩展器</h3> <h4 id="_1-创建认证token"><a href="#_1-创建认证token" class="header-anchor">#</a> 1.创建认证Token</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomAuthenticationToken</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationToken</span> <span class="token punctuation">{</span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">550L</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> principal<span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">CustomAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">public</span> <span class="token class-name">CustomAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">,</span>
			<span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> authorities<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span>authorities<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>credentials<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>principal<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isAuthenticated<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalArgumentException</span> <span class="token punctuation">{</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span><span class="token operator">!</span>isAuthenticated<span class="token punctuation">,</span>
				<span class="token string">&quot;Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">eraseCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><h4 id="_2-创建令牌授予者"><a href="#_2-创建令牌授予者" class="header-anchor">#</a> 2.创建令牌授予者</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomTokenGranter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTokenGranter</span> <span class="token punctuation">{</span>

	<span class="token comment">/**
	 * 声明授权者 CustomTokenGranter 支持授权模式 custom_code 根据接口传值 grant_type = custom_code 的值匹配到此授权者
	 * 匹配逻辑详见下面的两个方法
	 *
	 * @see CompositeTokenGranter#grant(String, TokenRequest)
	 * @see AbstractTokenGranter#grant(String, TokenRequest)
	 */</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">GRANT_TYPE</span> <span class="token operator">=</span> <span class="token string">&quot;custom_code&quot;</span><span class="token punctuation">;</span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">CustomTokenGranter</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerTokenServices</span> tokenServices<span class="token punctuation">,</span>
			<span class="token class-name">ClientDetailsService</span> clientDetailsService<span class="token punctuation">,</span> <span class="token class-name">OAuth2RequestFactory</span> requestFactory<span class="token punctuation">,</span>
			<span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span>tokenServices<span class="token punctuation">,</span> clientDetailsService<span class="token punctuation">,</span> requestFactory<span class="token punctuation">,</span> <span class="token constant">GRANT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager <span class="token operator">=</span> authenticationManager<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">protected</span> <span class="token class-name">OAuth2Authentication</span> <span class="token function">getOAuth2Authentication</span><span class="token punctuation">(</span><span class="token class-name">ClientDetails</span> client<span class="token punctuation">,</span> <span class="token class-name">TokenRequest</span> tokenRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> parameters <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashMap</span><span class="token punctuation">(</span>tokenRequest<span class="token punctuation">.</span><span class="token function">getRequestParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">String</span> mobile <span class="token operator">=</span> parameters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;mobile&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 手机号</span>
		<span class="token class-name">String</span> code <span class="token operator">=</span> parameters<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 短信验证码</span>

		parameters<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token class-name">Authentication</span> userAuth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomAuthenticationToken</span><span class="token punctuation">(</span>mobile<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractAuthenticationToken</span><span class="token punctuation">)</span> userAuth<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span>parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			userAuth <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationManager<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>userAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AccountStatusException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidGrantException</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BadCredentialsException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidGrantException</span><span class="token punctuation">(</span>exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>userAuth <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> userAuth<span class="token punctuation">.</span><span class="token function">isAuthenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token class-name">OAuth2Request</span> storedOAuth2Request <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createOAuth2Request</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> tokenRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OAuth2Authentication</span><span class="token punctuation">(</span>storedOAuth2Request<span class="token punctuation">,</span> userAuth<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidGrantException</span><span class="token punctuation">(</span><span class="token string">&quot;Could not authenticate user: &quot;</span> <span class="token operator">+</span> mobile<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-创建认证提供者"><a href="#_3-创建认证提供者" class="header-anchor">#</a> 3.创建认证提供者</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
  * 自定义认证逻辑
  *
  */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomAuthenticationProvider</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationProvider</span> <span class="token punctuation">{</span>

 

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">;</span>
    
    
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>
		<span class="token class-name">CustomAuthenticationToken</span> authenticationToken <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">CustomAuthenticationToken</span><span class="token punctuation">)</span> authentication<span class="token punctuation">;</span>
		<span class="token class-name">String</span> mobile <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> authenticationToken<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> authenticationToken<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//自定义提取信息方式</span>
<span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ExtendUserDetailsService</span><span class="token punctuation">)</span> userDetailsService<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loginByMobile</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">CustomAuthenticationToken</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomAuthenticationToken</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">,</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				<span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		result<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">supports</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> authentication<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token class-name">CustomAuthenticationToken</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>4.注册认证提供者</p> <div class="language- extra-class"><pre class="language-text"><code>	@Bean
	public CustomAuthenticationProvider CustomAuthenticationProvider(UserDetailsService userDetailsService) {
		CustomAuthenticationProvider provider = new CustomAuthenticationProvider(userDetailsService);
		return provider;
	}
</code></pre></div><h4 id="_5-注册自定义令牌授予者"><a href="#_5-注册自定义令牌授予者" class="header-anchor">#</a> 5.注册自定义令牌授予者</h4> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token annotation punctuation">@Bean</span>
	<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
	<span class="token keyword">public</span> <span class="token class-name">TokenGrantBuilder</span> <span class="token function">tokenGrantBuilder</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">,</span>
			<span class="token annotation punctuation">@Autowired</span><span class="token punctuation">(</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">CaptchaValidator</span> captchaValidator<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// 添加验证码授权模式授权者</span>
		<span class="token class-name">TokenGranterProvider</span> captchaTokenGranter <span class="token operator">=</span> endpoints <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">CaptchaTokenGranter</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">.</span><span class="token function">getTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				endpoints<span class="token punctuation">.</span><span class="token function">getClientDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> endpoints<span class="token punctuation">.</span><span class="token function">getOAuth2RequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authenticationManager<span class="token punctuation">,</span>
				captchaValidator<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
<span class="token class-name">CustomTokenGranter</span> customTokenGranter <span class="token operator">=</span> endpoints <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">CustomTokenGranter</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">.</span><span class="token function">getTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
				endpoints<span class="token punctuation">.</span><span class="token function">getClientDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> endpoints<span class="token punctuation">.</span><span class="token function">getOAuth2RequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TokenGranterProvider</span><span class="token punctuation">&gt;</span></span> tokenGranterProviderList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		tokenGranterProviderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>captchaTokenGranter<span class="token punctuation">)</span><span class="token punctuation">;</span>
       tokenGranterProviderList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>customTokenGranter<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">TokenGrantBuilder</span> tokenGrantBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenGrantBuilder</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">,</span> tokenGranterProviderList<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> tokenGrantBuilder<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><h2 id="三、退出端点构造"><a href="#三、退出端点构造" class="header-anchor">#</a> 三、退出端点构造</h2> <h3 id="_1-jwt形式"><a href="#_1-jwt形式" class="header-anchor">#</a> 1.JWT形式</h3> <p>JWT最大的一个优势在于它是<strong>无状态</strong>的，自身包含了认证鉴权所需要的所有信息，服务器端无需对其存储，从而给服务器减少了存储开销。</p> <p>但是无状态引出的问题也是可想而知的，它无法作废未过期的JWT。</p> <p>首先明确一点JWT失效的唯一途径就是等过期，就是说不借助外力的情况下，无法达到某些场景下需要主动使JWT失效的目的。而外力则是在服务器端存储着JWT的状态，在请求资源时添加判断逻辑，这与JWT特性无状态是相互矛盾的存在。但是，你要知道如果你选择走上了JWT这条路，那就没得选了。</p> <p>以下就JWT在某些场景需要失效的简单方案整理如下：</p> <h4 id="_1-白名单方式"><a href="#_1-白名单方式" class="header-anchor">#</a> <strong>1. 白名单方式</strong></h4> <p>认证通过时，把JWT缓存到Redis，注销时，从缓存移除JWT。请求资源添加判断JWT在缓存中是否存在，不存在拒绝访问。这种方式和cookie/session机制中的会话失效删除session基本一致。</p> <h4 id="_2-黑名单方式"><a href="#_2-黑名单方式" class="header-anchor">#</a> <strong>2. 黑名单方式</strong></h4> <p>注销登录时，缓存JWT至Redis，且缓存有效时间设置为JWT的有效期，请求资源时判断是否存在缓存的黑名单中，存在则拒绝访问。</p> <p>白名单和黑名单的实现逻辑差不多，黑名单不需每次登录都将JWT缓存，仅仅在某些特殊场景下需要缓存JWT，给服务器带来的压力要远远小于白名单的方式。</p> <h5 id="实现方案"><a href="#实现方案" class="header-anchor">#</a> 实现方案：</h5> <p>1.调用退出登录接口  <code>/oauth/logout</code></p> <p>2.将JWT缓存到Redis的黑名单，可以将JWT载体中的jti作为唯一标识</p> <p>3.判定请求头的JWT是否在黑名单内做对应的处理</p> <p>JWT解析的结构如下：</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/20220726172350.png" alt=""></p> <p>既然有这么个字段能作为JWT的唯一标识，从JWT解析出jti之后将其存储到黑名单中作为判别依据，</p> <p>相较于存储完整的JWT字符串减少了存储开销。</p> <p>另外我们只需保证JWT在其有效期内用户登出后失效就可以了，</p> <p>JWT有效期过了黑名单也就没有存在的必要，所以我们这里还需要设置黑名单的过期时间，不然黑名单的数量会无休止的越来越多，这是我们不想看到的。</p> <ul><li><strong>AuthController.java</strong></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Api</span><span class="token punctuation">(</span>tags <span class="token operator">=</span> <span class="token string">&quot;认证中心&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> payload <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">AuthConstants</span><span class="token punctuation">.</span><span class="token constant">JWT_PAYLOAD_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">parseObj</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> jti <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getStr</span><span class="token punctuation">(</span><span class="token string">&quot;jti&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// JWT唯一标识</span>
        <span class="token keyword">long</span> exp <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token string">&quot;exp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// JWT过期时间戳(单位:秒)</span>

        <span class="token keyword">long</span> currentTimeSeconds <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>exp <span class="token operator">&lt;</span> currentTimeSeconds<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// token已过期</span>
            <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">ResultCode</span><span class="token punctuation">.</span><span class="token constant">INVALID_TOKEN_OR_EXPIRED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">AuthConstants</span><span class="token punctuation">.</span><span class="token constant">TOKEN_BLACKLIST_PREFIX</span> <span class="token operator">+</span> jti<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>exp <span class="token operator">-</span> currentTimeSeconds<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><ul><li><p>AuthRequestFilter.java</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthRequestFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
</code></pre></div><p>}</p> <p>@Override
protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws ServletException, IOException {
String token = request.getHeaders(AuthConstants.JWT_TOKEN_HEADER);
if (StrUtil.isBlank(token)) {
chain.doFilter(request,response);
return;
}
token = token.replace(AuthConstants.JWT_TOKEN_PREFIX, Strings.EMPTY);
JWSObject jwsObject = JWSObject.parse(token);
String payload = jwsObject.getPayload().toString();</p> <div class="language- extra-class"><pre><code>  // 黑名单token(登出、修改密码)校验
  JSONObject jsonObject = JSONUtil.parseObj(payload);
  String jti = jsonObject.getStr(&quot;jti&quot;); // JWT唯一标识

  Boolean isBlack = redisTemplate.hasKey(AuthConstants.TOKEN_BLACKLIST_PREFIX + jti);
  if (isBlack) {

      response.setStatusCode(HttpStatus.OK);
      response.setHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE);
      response.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);
      response.setHeader(&quot;Cache-Control&quot;, &quot;no-cache&quot;);
      String body = JSONUtil.toJsonStr(R.failed(ResultCode.INVALID_TOKEN_OR_EXPIRED));
      ServletUtils.renderString(response,body);
      return;
  }



  chain.doFilter(request,response);
</code></pre></div><p>}</p> <p>@Override
public int getOrder() {
return 0;
}
}</p> <div class="language- extra-class"><pre class="language-text"><code>
</code></pre></div></li></ul> <h3 id="_2-redis形式"><a href="#_2-redis形式" class="header-anchor">#</a> 2.Redis形式</h3> <ul><li><strong>AuthController.java</strong></li></ul> <p>​```java
@RestController
@RequestMapping(&quot;/oauth&quot;)
@RequiredArgsConstructor</p> <p>public class AuthController {</p> <div class="language- extra-class"><pre><code>private final TokenStore tokenStore;

private final ApplicationEventPublisher publisher;

/**
 * 退出token
 * @param authHeader Authorization
 */
@DeleteMapping(&quot;/logout&quot;)
public R&lt;Void&gt; logout(@RequestHeader(value = HttpHeaders.AUTHORIZATION, required = false) String authHeader) {
	if (StrUtil.isBlank(authHeader)) {
		return R.failed(SysResultCode.FORBIDDEN, &quot;退出失败，token 为空&quot;);
	}

	String tokenValue = authHeader.replace(OAuth2AccessToken.BEARER_TYPE, StrUtil.EMPTY).trim();
	OAuth2AccessToken accessToken = tokenStore.readAccessToken(tokenValue);
	if (accessToken == null || StrUtil.isBlank(accessToken.getValue())) {
		return R.failed(SysResultCode.FORBIDDEN, &quot;退出失败，token 无效&quot;);
	}

	OAuth2Authentication auth2Authentication = tokenStore.readAuthentication(accessToken);

	// 清空access token
	tokenStore.removeAccessToken(accessToken);
	// 清空 refresh token
	OAuth2RefreshToken refreshToken = accessToken.getRefreshToken();
	if (refreshToken!=null){
		tokenStore.removeRefreshToken(refreshToken);
	}
	// 发布用户登出事件
	//publisher.publishEvent(new LogoutSuccessEvent(auth2Authentication));

	return R.ok();
}
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>


##  四、授权码模式页面定制

#### 登录页面重定制

默认的登录页面，如下图：

![img](https://pics2.baidu.com/feed/314e251f95cad1c8136caadb6d7af703cb3d51c1.png?token=7f9dca6be98bb5c62ea0889115d76e7b)

如何定制?

1.定制页面

![img](https://pics0.baidu.com/feed/9e3df8dcd100baa17da1146b59542918c9fc2e1b.png?token=b5e844a5adf80ada60489b231582ba03)

使用thymeleaf进行渲染。

2.定义跳转接口

```java
@ApiOperation(value = &quot;表单登录跳转页面&quot;)@GetMapping(&quot;/oauth/login&quot;)public String loginPage(Model model){    //返回跳转页面   
  return &quot;oauth-login&quot;;}
</code></pre></div><p>3.Spring Security 中配置</p> <ul><li>loginProcessingUrl：这个是定义的form表单提交的url。</li> <li>loginPage：这个是定义跳转登录页面的url。</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> http<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
		http<span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loginProcessingUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/form/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token constant">AUTHORIZE_ENDPOINT_PATH</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>4.查看效果</p> <p><img src="https://pics4.baidu.com/feed/908fa0ec08fa513d42f37fbb2a29c5f1b3fbd9cc.png?token=66021a4d978ae8501c5819eb9ac55431" alt="img"></p> <h4 id="授权页面重定制"><a href="#授权页面重定制" class="header-anchor">#</a> 授权页面重定制</h4> <p>默认的授权页面什么熊样，如下图:</p> <p><img src="https://pics7.baidu.com/feed/2934349b033b5bb55573043d2f974533b700bc1f.png?token=1437346ae67ce04fcbf81d1e67d12210" alt="img"></p> <p>1.定制页面</p> <p><img src="https://pics1.baidu.com/feed/eaf81a4c510fd9f96ad388f73c6944202934a433.png?token=c3e1d103b0ed5f0822620aa31370ae2a" alt="img"></p> <p>2.定义接口跳转</p> <p>授权页面的跳转接口url：/oauth/confirm_access，这个接口定义在org.springframework.security.oauth2.provider.endpoint.WhitelabelApprovalEndpoint中，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>
	<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth/confirm_access&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">ModelAndView</span> <span class="token function">getAccessConfirmation</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> model<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
		<span class="token keyword">final</span> <span class="token class-name">String</span> approvalContent <span class="token operator">=</span> <span class="token function">createTemplate</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;_csrf&quot;</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			model<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;_csrf&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;_csrf&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">View</span> approvalView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">View</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token string">&quot;text/html&quot;</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> model<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
				response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>approvalContent<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span>approvalView<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><p>自定义也很简单，只需要模仿这个接口自定义一个将其覆盖即可.</p> <p>注意：@SessionAttributes(&quot;authorizationRequest&quot;)这个注解一定要标注，授权请求信息是存储在session中。</p> <p>3.修改默认映射地址</p> <p>若不修改映射地址 ，则无需执行此步骤</p> <p>默认的跳转接口是：/oauth/confirm_access 若想变动则需要进行如下配置</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//授权页面url</span>
		endpoints<span class="token punctuation">.</span><span class="token function">pathMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth/confirm_access&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;custom/confirm_access&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>按照上述3个步骤即可轻松的实现授权页面自定义，效果如下</p> <p><img src="https://pics6.baidu.com/feed/a8ec8a13632762d08f2e9654bda898f0503dc693.png?token=7d816da7d148f406b86c1f4dcb32e4d3" alt="img"></p> <h4 id="异常页面重定制"><a href="#异常页面重定制" class="header-anchor">#</a> 异常页面重定制</h4> <p>异常页面什么意思呢?授权码的请求url如下</p> <div class="language-java extra-class"><pre class="language-java"><code>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">9001</span><span class="token operator">/</span>blog<span class="token operator">-</span>auth<span class="token operator">-</span>server<span class="token operator">/</span>oauth<span class="token operator">/</span>authorize<span class="token operator">?</span>client_id<span class="token operator">=</span>mugu<span class="token operator">&amp;</span>response_type<span class="token operator">=</span>code<span class="token operator">&amp;</span>scope<span class="token operator">=</span>all<span class="token operator">&amp;</span>redirect_uri<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com

</code></pre></div><p>假设我将的租户id(client_id)修改成数据库中不存在的值，那么将会触犯异常页面，页面如下：</p> <p><img src="https://pics7.baidu.com/feed/c8ea15ce36d3d53905d13f2428c3795a342ab033.png?token=56f14401fd246335ac0529d2e968ea03" alt="img"></p> <p>这个异常页面是不是不太符合系统的要求，肯定是要自定义的。</p> <p>1.定制页面</p> <p><img src="https://pics4.baidu.com/feed/77c6a7efce1b9d16da381294e99a24858d546412.png?token=09b553af186a75f9d1bbeafe6f00426b" alt="img"></p> <p>2.定义跳转地址</p> <p>这个跳转的接口的逻辑在AuthorizationEndpoint中</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token keyword">private</span> <span class="token class-name">ModelAndView</span> <span class="token function">handleException</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">,</span> <span class="token class-name">ServletWebRequest</span> webRequest<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

		<span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OAuth2Exception</span><span class="token punctuation">&gt;</span></span> translate <span class="token operator">=</span> <span class="token function">getExceptionTranslator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
		webRequest<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>translate<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">ClientAuthenticationException</span> <span class="token operator">||</span> e <span class="token keyword">instanceof</span> <span class="token class-name">RedirectMismatchException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span>errorPage<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonMap</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> translate<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token class-name">AuthorizationRequest</span> authorizationRequest <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">{</span>
			authorizationRequest <span class="token operator">=</span> <span class="token function">getAuthorizationRequestForError</span><span class="token punctuation">(</span>webRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> requestedRedirectParam <span class="token operator">=</span> authorizationRequest<span class="token punctuation">.</span><span class="token function">getRequestParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">OAuth2Utils</span><span class="token punctuation">.</span><span class="token constant">REDIRECT_URI</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> requestedRedirect <span class="token operator">=</span> redirectResolver<span class="token punctuation">.</span><span class="token function">resolveRedirect</span><span class="token punctuation">(</span>requestedRedirectParam<span class="token punctuation">,</span>
					<span class="token function">getClientDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClientByClientId</span><span class="token punctuation">(</span>authorizationRequest<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			authorizationRequest<span class="token punctuation">.</span><span class="token function">setRedirectUri</span><span class="token punctuation">(</span>requestedRedirect<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token class-name">String</span> redirect <span class="token operator">=</span> <span class="token function">getUnsuccessfulRedirect</span><span class="token punctuation">(</span>authorizationRequest<span class="token punctuation">,</span> translate<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authorizationRequest
					<span class="token punctuation">.</span><span class="token function">getResponseTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RedirectView</span><span class="token punctuation">(</span>redirect<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OAuth2Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// If an AuthorizationRequest cannot be created from the incoming parameters it must be</span>
			<span class="token comment">// an error. OAuth2Exception can be handled this way. Other exceptions will generate a standard 500</span>
			<span class="token comment">// response.</span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span>errorPage<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonMap</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> translate<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>
</code></pre></div><p>因此只需要重新定义一个接口进行跳转即可，如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;处理授权异常的跳转页面&quot;</span><span class="token punctuation">)</span><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth/error&quot;</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">Model</span> model<span class="token punctuation">)</span><span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token string">&quot;oauth-error&quot;</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

</code></pre></div><p>3.修改默认的映射地址</p> <p>若不修改映射地址 ，则无需执行此步骤</p> <p>默认的映射地址为/oauth/error，修改也很简单，只需要在OAuth2的认证服务的配置类：继承AuthorizationServerConfigurerAdapter的配置中修改一下配置</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">//授权页面url</span>
		endpoints<span class="token punctuation">.</span><span class="token function">pathMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/oauth/error&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;custom/error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>按照上述3个步骤即可轻松的实现异常页面自定义，效果如下：</p> <p><img src="https://pics5.baidu.com/feed/96dda144ad345982e21da35917b0a1a7caef8430.png?token=0764967356509c142d772c03e249c3f8" alt="img"></p> <h2 id="五、多用户体系刷新模式"><a href="#五、多用户体系刷新模式" class="header-anchor">#</a> 五、多用户体系刷新模式</h2> <p>如果只是针对一种用户体系以及一种认证方式(用户名/手机号/openid)的话，比如<code>验证码</code> 模式的扩展，就不需要对<code>刷新模式</code>做调整。</p> <p>但是如果是多用户体系或者多种认证方式，就必须做些调整来适配。</p> <h3 id="_1-原理"><a href="#_1-原理" class="header-anchor">#</a> 1. 原理</h3> <p><code>刷新模式</code> 时序图如下，相较于密码模式还只是 <code>Granter</code> 和 <code>Provider</code>的变动。</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/20220729113135.png" alt=""></p> <p>着重说一下刷新模式的认证提供者 <code>PreAuthenticatedAuthenticationProvider</code> ，其 authenticate() 认证方法只做<strong>用户状态校验</strong>，check() 方法调用 AccountStatusUserDetailsChecker#check(UserDetails)。</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/20220729113159.png" alt=""></p> <p>注意 下<code>this.preAuthenticatedUserDetailsService.loadUserDetails((PreAuthenticatedAuthenticationToken)authentication);</code> 的 <code>preAuthenticatedUserDetailsService</code> 用户服务。</p> <p>在没有进行授权模式扩展的时候，是下面这样设置的</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/20220729113219.png" alt=""></p> <p>然后在 <code>AuthorizationServerEndpointsConfigurer#addUserDetailsService(DefaultTokenServices,UserDetailsService)</code> 构造 <code>PreAuthenticatedAuthenticationProvider</code> 里设置了 <code>UserDetailService</code>用户服务。</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/20220729113256.png" alt=""></p> <p>这样在多用户体系认证下问题可想而知，用户分别有系统用户和会员用户，这里固定成一个用户服务肯定是行不通的。</p> <h3 id="_2-实战"><a href="#_2-实战" class="header-anchor">#</a> 2.实战</h3> <p>首先我们清楚一个 OAuth2 客户端基本对应的是一个用户体系</p> <table><thead><tr><th>OAuth2 客户端名称</th> <th>OAuth2 客户端ID</th> <th>用户体系</th></tr></thead> <tbody><tr><td>管理系统</td> <td>admin</td> <td>系统用户</td></tr> <tr><td>移动端</td> <td>client</td> <td>会员用户</td></tr></tbody></table> <p>那就有一个很简单有效的思路，可以在系统内部维护一个如上表的映射关系 Map，然后根据传递的客户端ID去选择用户体系或刷新模式。</p> <h4 id="思路1"><a href="#思路1" class="header-anchor">#</a> 思路1：</h4> <h5 id="_1-创建provider指定用户体系"><a href="#_1-创建provider指定用户体系" class="header-anchor">#</a> 1.创建provider指定用户体系</h5> <p>扩展授权模式创建 <code>Provider</code> 时可以指定具体的用户服务 <code>UserDetailService</code>，就如下面这样：</p> <p><img src="https://cdn.jsdelivr.net/gh/xiaoashuo/pics/oauth2/20220729113315.png" alt=""></p> <h5 id="_2-刷新模式指定客户体系调用"><a href="#_2-刷新模式指定客户体系调用" class="header-anchor">#</a> 2.刷新模式指定客户体系调用</h5> <p>你可以为每个授权模式扩展新增对应的刷新模式，但是这样的话比较麻烦，本文的实现方案核心图的是简单有效，所以这里使用的另一种方案，重新设置<code>PreAuthenticatedAuthenticationProvider</code> 的 preAuthenticatedUserDetailsService 属性，让其有判断选择用户体系和认证方式的能力。</p> <p>新增的 PreAuthenticatedUserDetailsService 可根据客户端和认证方式选择UserDetailService 和方法获取用户信息 UserDetail</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 刷新token再次认证 UserDetailsService
 *
 * @author &lt;a href=&quot;mailto:xianrui0365@163.com&quot;&gt;xianrui&lt;/a&gt;
 * @date 2021/10/2
 */</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PreAuthenticatedUserDetailsService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Authentication</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationUserDetailsService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 客户端ID和用户服务 UserDetailService 的映射
     *
     * @see com.youlai.auth.security.config.AuthorizationServerConfig#tokenServices(AuthorizationServerEndpointsConfigurer)
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">UserDetailsService</span><span class="token punctuation">&gt;</span></span> userDetailsServiceMap<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">PreAuthenticatedUserDetailsService</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">UserDetailsService</span><span class="token punctuation">&gt;</span></span> userDetailsServiceMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>userDetailsServiceMap<span class="token punctuation">,</span> <span class="token string">&quot;userDetailsService cannot be null.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsServiceMap <span class="token operator">=</span> userDetailsServiceMap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsServiceMap<span class="token punctuation">,</span> <span class="token string">&quot;UserDetailsService must be set&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 重写PreAuthenticatedAuthenticationProvider 的 preAuthenticatedUserDetailsService 属性，可根据客户端和认证方式选择用户服务 UserDetailService 获取用户信息 UserDetail
     *
     * @param authentication
     * @return
     * @throws UsernameNotFoundException
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserDetails</span><span class="token punctuation">(</span><span class="token class-name">T</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> clientId <span class="token operator">=</span> <span class="token class-name">RequestUtils</span><span class="token punctuation">.</span><span class="token function">getOAuth2ClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取认证方式，默认是用户名 username</span>
        <span class="token class-name">AuthenticationMethodEnum</span> authenticationMethodEnum <span class="token operator">=</span> <span class="token class-name">AuthenticationMethodEnum</span><span class="token punctuation">.</span><span class="token function">getByValue</span><span class="token punctuation">(</span><span class="token class-name">RequestUtils</span><span class="token punctuation">.</span><span class="token function">getAuthenticationMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">UserDetailsService</span> userDetailsService <span class="token operator">=</span> userDetailsServiceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span><span class="token constant">APP_CLIENT_ID</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 移动端的用户体系是会员，认证方式是通过手机号 mobile 认证</span>
            <span class="token class-name">MemberUserDetailsServiceImpl</span> memberUserDetailsService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MemberUserDetailsServiceImpl</span><span class="token punctuation">)</span> userDetailsService<span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>authenticationMethodEnum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token constant">MOBILE</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> memberUserDetailsService<span class="token punctuation">.</span><span class="token function">loadUserByMobile</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> memberUserDetailsService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>clientId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span><span class="token constant">ADMIN_CLIENT_ID</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 管理系统的用户体系是系统用户，认证方式通过用户名 username 认证</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>authenticationMethodEnum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> userDetailsService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> userDetailsService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>AuthorizationServerConfig 配置重新设置 PreAuthenticatedAuthenticationProvider 的 preAuthenticatedUserDetailsService 属性值</p> <div class="language-java extra-class"><pre class="language-java"><code>  <span class="token comment">/**
     * 配置授权（authorization）以及令牌（token）的访问端点和令牌服务(token services)
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Token增强</span>
        <span class="token class-name">TokenEnhancerChain</span> tokenEnhancerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenEnhancerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TokenEnhancer</span><span class="token punctuation">&gt;</span></span> tokenEnhancers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenEnhancers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">tokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenEnhancers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenEnhancerChain<span class="token punctuation">.</span><span class="token function">setTokenEnhancers</span><span class="token punctuation">(</span>tokenEnhancers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取原有默认授权模式(授权码模式、密码模式、客户端模式、简化模式)的授权者</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TokenGranter</span><span class="token punctuation">&gt;</span></span> granterList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">.</span><span class="token function">getTokenGranter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加验证码授权模式授权者</span>
        granterList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CaptchaTokenGranter</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">.</span><span class="token function">getTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> endpoints<span class="token punctuation">.</span><span class="token function">getClientDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                endpoints<span class="token punctuation">.</span><span class="token function">getOAuth2RequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authenticationManager<span class="token punctuation">,</span> stringRedisTemplate
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加手机短信验证码授权模式的授权者</span>
        granterList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SmsCodeTokenGranter</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">.</span><span class="token function">getTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> endpoints<span class="token punctuation">.</span><span class="token function">getClientDetailsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                endpoints<span class="token punctuation">.</span><span class="token function">getOAuth2RequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> authenticationManager
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token class-name">CompositeTokenGranter</span> compositeTokenGranter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompositeTokenGranter</span><span class="token punctuation">(</span>granterList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        endpoints
                <span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">accessTokenConverter</span><span class="token punctuation">(</span><span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">tokenEnhancer</span><span class="token punctuation">(</span>tokenEnhancerChain<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">tokenGranter</span><span class="token punctuation">(</span>compositeTokenGranter<span class="token punctuation">)</span>
                <span class="token comment">/** refresh token有两种使用方式：重复使用(true)、非重复使用(false)，默认为true
                 *  1 重复使用：access token过期刷新时， refresh token过期时间未改变，仍以初次生成的时间为准
                 *  2 非重复使用：access token过期刷新时， refresh token过期时间延续，在refresh token有效期内刷新便永不失效达到无需再次登录的目的
                 */</span>
                <span class="token punctuation">.</span><span class="token function">reuseRefreshTokens</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">tokenServices</span><span class="token punctuation">(</span><span class="token function">tokenServices</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token class-name">DefaultTokenServices</span> <span class="token function">tokenServices</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TokenEnhancerChain</span> tokenEnhancerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TokenEnhancerChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TokenEnhancer</span><span class="token punctuation">&gt;</span></span> tokenEnhancers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenEnhancers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">tokenEnhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenEnhancers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">jwtAccessTokenConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenEnhancerChain<span class="token punctuation">.</span><span class="token function">setTokenEnhancers</span><span class="token punctuation">(</span>tokenEnhancers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">DefaultTokenServices</span> tokenServices <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTokenServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenServices<span class="token punctuation">.</span><span class="token function">setTokenStore</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">.</span><span class="token function">getTokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenServices<span class="token punctuation">.</span><span class="token function">setSupportRefreshToken</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenServices<span class="token punctuation">.</span><span class="token function">setClientDetailsService</span><span class="token punctuation">(</span>clientDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenServices<span class="token punctuation">.</span><span class="token function">setTokenEnhancer</span><span class="token punctuation">(</span>tokenEnhancerChain<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 多用户体系下，刷新token再次认证客户端ID和 UserDetailService 的映射Map</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">UserDetailsService</span><span class="token punctuation">&gt;</span></span> clientUserDetailsServiceMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        clientUserDetailsServiceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span><span class="token constant">ADMIN_CLIENT_ID</span><span class="token punctuation">,</span> sysUserDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 管理系统客户端</span>
        clientUserDetailsServiceMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span><span class="token constant">APP_CLIENT_ID</span><span class="token punctuation">,</span> memberUserDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Android/IOS/H5 移动客户端</span>

        <span class="token comment">// 重新设置PreAuthenticatedAuthenticationProvider#preAuthenticatedUserDetailsService 能够根据客户端ID和认证方式区分用户体系获取认证用户信息</span>
        <span class="token class-name">PreAuthenticatedAuthenticationProvider</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PreAuthenticatedAuthenticationProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        provider<span class="token punctuation">.</span><span class="token function">setPreAuthenticatedUserDetailsService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PreAuthenticatedUserDetailsService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>clientUserDetailsServiceMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tokenServices<span class="token punctuation">.</span><span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProviderManager</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>provider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> tokenServices<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="思路2"><a href="#思路2" class="header-anchor">#</a> 思路2：</h4> <h5 id="_1-注册授权信息处理"><a href="#_1-注册授权信息处理" class="header-anchor">#</a> 1.注册授权信息处理</h5> <blockquote><p>支持多用户授权体系刷新模式，默认注册 password与sms_code 模式</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">AuthorizationInfoHandle</span> <span class="token function">authorizationInfoHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationInfoHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">grantType</span><span class="token punctuation">(</span><span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RetriveUserFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Authentication</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">UserDetails</span> <span class="token function">retrive</span><span class="token punctuation">(</span><span class="token class-name">T</span> authentication<span class="token punctuation">,</span>
					<span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">String</span> name <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> userDetailsService<span class="token punctuation">.</span><span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">grantType</span><span class="token punctuation">(</span><span class="token string">&quot;sms_code&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RetriveUserFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token annotation punctuation">@Override</span>
			<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">Authentication</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">UserDetails</span> <span class="token function">retrive</span><span class="token punctuation">(</span><span class="token class-name">T</span> authentication<span class="token punctuation">,</span>
					<span class="token class-name">UserDetailsService</span> userDetailsService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token class-name">String</span> name <span class="token operator">=</span> authentication<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">ExtendUserDetailsService</span> extendUserDetailsService <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ExtendUserDetailsService</span><span class="token punctuation">)</span> userDetailsService<span class="token punctuation">;</span>
				<span class="token keyword">return</span> extendUserDetailsService<span class="token punctuation">.</span><span class="token function">loginByMobile</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

</code></pre></div><h5 id="_2-注册-userdetailservice代理"><a href="#_2-注册-userdetailservice代理" class="header-anchor">#</a> 2.注册 <code>UserDetailService</code>代理</h5> <blockquote><p>注:若不注册此代理 则多用户体系不生效</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>	

<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">UserService</span> <span class="token function">userService</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationInfoHandle</span> authorizationInfoHandle<span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token class-name">ProxyFactory</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PreMethodInterceptor</span><span class="token punctuation">(</span>authorizationInfoHandle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/relaxed-docs/zh/blogs/Mybatis实现字段加解密.html" class="prev">
          Mybtias实现字段加解密
        </a></span> <span class="next"><a href="/relaxed-docs/zh/blogs/Cache模块.html">
          Cache模块
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#简介" class="sidebar-link reco-side-简介" data-v-b57cc07c>简介</a></li><li class="level-2" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#角色" class="sidebar-link reco-side-角色" data-v-b57cc07c>角色</a></li><li class="level-2" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#协议流程" class="sidebar-link reco-side-协议流程" data-v-b57cc07c>协议流程</a></li><li class="level-2" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#授权许可" class="sidebar-link reco-side-授权许可" data-v-b57cc07c>授权许可</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#授权码-authorization-code" class="sidebar-link reco-side-授权码-authorization-code" data-v-b57cc07c>授权码 Authorization Code</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#隐式授权-implicit" class="sidebar-link reco-side-隐式授权-implicit" data-v-b57cc07c>隐式授权 Implicit</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#资源所有者密码凭证-resource-owner-password-credentials" class="sidebar-link reco-side-资源所有者密码凭证-resource-owner-password-credentials" data-v-b57cc07c>资源所有者密码凭证 Resource Owner Password Credentials</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#客户端凭证-client-credentials" class="sidebar-link reco-side-客户端凭证-client-credentials" data-v-b57cc07c>客户端凭证 Client Credentials</a></li><li class="level-2" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#一、授权服务器" class="sidebar-link reco-side-一、授权服务器" data-v-b57cc07c>一、授权服务器</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_1-依赖引入" class="sidebar-link reco-side-_1-依赖引入" data-v-b57cc07c>1.依赖引入</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_2-配置客户端信息" class="sidebar-link reco-side-_2-配置客户端信息" data-v-b57cc07c>2.配置客户端信息</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_3-配置令牌存储" class="sidebar-link reco-side-_3-配置令牌存储" data-v-b57cc07c>3.配置令牌存储</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_4-配置token增强-可选" class="sidebar-link reco-side-_4-配置token增强-可选" data-v-b57cc07c>4.配置Token增强(可选)</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_5-配置用户信息服务" class="sidebar-link reco-side-_5-配置用户信息服务" data-v-b57cc07c>5.配置用户信息服务</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_6-开启授权服务器" class="sidebar-link reco-side-_6-开启授权服务器" data-v-b57cc07c>6.开启授权服务器</a></li><li class="level-2" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#二、资源服务器" class="sidebar-link reco-side-二、资源服务器" data-v-b57cc07c>二、资源服务器</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_1-依赖引入-2" class="sidebar-link reco-side-_1-依赖引入-2" data-v-b57cc07c>1.依赖引入</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_2-application-yml" class="sidebar-link reco-side-_2-application-yml" data-v-b57cc07c>2.application.yml</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_3-开启资源服务器" class="sidebar-link reco-side-_3-开启资源服务器" data-v-b57cc07c>3.开启资源服务器</a></li><li class="level-2" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#三、使用方式" class="sidebar-link reco-side-三、使用方式" data-v-b57cc07c>三、使用方式</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_1-授权码模式" class="sidebar-link reco-side-_1-授权码模式" data-v-b57cc07c>1.授权码模式</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_2-密码模式" class="sidebar-link reco-side-_2-密码模式" data-v-b57cc07c>2.密码模式</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_3-implicit-简化模式" class="sidebar-link reco-side-_3-implicit-简化模式" data-v-b57cc07c>3.Implicit（简化模式）</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_4-客户端凭证" class="sidebar-link reco-side-_4-客户端凭证" data-v-b57cc07c>4.客户端凭证</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_5-刷新token" class="sidebar-link reco-side-_5-刷新token" data-v-b57cc07c>5.刷新Token</a></li><li class="level-2" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#一、附带sql" class="sidebar-link reco-side-一、附带sql" data-v-b57cc07c>一、附带sql</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_1-oauth-client-details" class="sidebar-link reco-side-_1-oauth-client-details" data-v-b57cc07c>1.oauthclientdetails</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_2-oauth-code" class="sidebar-link reco-side-_2-oauth-code" data-v-b57cc07c>2.oauth_code</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_3-oauth-access-token" class="sidebar-link reco-side-_3-oauth-access-token" data-v-b57cc07c>3.oauthaccesstoken</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_4-oauth-refresh-token" class="sidebar-link reco-side-_4-oauth-refresh-token" data-v-b57cc07c>4.oauthrefreshtoken</a></li><li class="level-2" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#二、扩展授权服务器" class="sidebar-link reco-side-二、扩展授权服务器" data-v-b57cc07c>二、扩展授权服务器</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#内置扩展器" class="sidebar-link reco-side-内置扩展器" data-v-b57cc07c>内置扩展器</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#拓展扩展器" class="sidebar-link reco-side-拓展扩展器" data-v-b57cc07c>拓展扩展器</a></li><li class="level-2" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#三、退出端点构造" class="sidebar-link reco-side-三、退出端点构造" data-v-b57cc07c>三、退出端点构造</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_1-jwt形式" class="sidebar-link reco-side-_1-jwt形式" data-v-b57cc07c>1.JWT形式</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_2-redis形式" class="sidebar-link reco-side-_2-redis形式" data-v-b57cc07c>2.Redis形式</a></li><li class="level-2" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#五、多用户体系刷新模式" class="sidebar-link reco-side-五、多用户体系刷新模式" data-v-b57cc07c>五、多用户体系刷新模式</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_1-原理" class="sidebar-link reco-side-_1-原理" data-v-b57cc07c>1. 原理</a></li><li class="level-3" data-v-b57cc07c><a href="/relaxed-docs/zh/blogs/Oauth2%E6%A8%A1%E5%9D%97.html#_2-实战" class="sidebar-link reco-side-_2-实战" data-v-b57cc07c>2.实战</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/relaxed-docs/assets/js/app.600cf0bb.js" defer></script><script src="/relaxed-docs/assets/js/7.58e239fa.js" defer></script><script src="/relaxed-docs/assets/js/2.a3c8aac3.js" defer></script><script src="/relaxed-docs/assets/js/1.ecce0b60.js" defer></script><script src="/relaxed-docs/assets/js/47.d1de22f4.js" defer></script>
  </body>
</html>
